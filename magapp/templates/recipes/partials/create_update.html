{% extends base_template %}
{% load static %}
{% block content %}

    <section id='section' class="bg-white dark:bg-gray-900">
        <div class="py-8 px-16 mx-auto py-16">
            <h2 class="mb-4 text-xl font-bold text-gray-900 dark:text-white">Nova receita</h2>
            <form
                    hx-post="{% url 'recipes:create' %}"
                    hx-swap="outerHTML"
                    hx-target="#section"
            >
                <div class="flex flex-col gap-4 ">
                    <!-- Title -->
                    <div class="w-1/2">
                        <label for="name" class="input-label">
                            {{ recipe_form.title.label }}
                        </label>
                        <input type="text"
                               name="{{ recipe_form.title.name }}"
                               id="name"
                                {% if form.title.errors %}
                               class="input-error"
                                {% else %}
                               class="input"
                                {% endif %}
                               value="{{ recipe_form.title.value | default_if_none:'' }}"
                               placeholder="{{ recipe_form.title.help_text }}"
                               required>
                        {% for err in recipe_form.title.errors %}
                            <p class="input-error-message">{{ err }}
                            </p>
                        {% endfor %}

                    </div>
                    <!-- description -->
                    <div class="sm:col-span-2">
                        <label for="description" class="input-label">
                            {{ recipe_form.description.label }}
                        </label>
                        <textarea id="description" rows="8"
                                  name="{{ recipe_form.description.name }}"
                                  value="{{ recipe_form.description.value }}"
                                {% if form.title.errors %}
                                  class="textarea-error"
                                {% else %}
                                  class="textarea"
                                {% endif %}
                                  placeholder="{{ recipe_form.description.help_text }}"
                                  required></textarea>
                        {% for err in recipe_form.description.errors %}
                            <p class="input-error-message">{{ err }}
                            </p>
                        {% endfor %}

                    </div>

                    <!-- font -->
                    <div class="">
                        <label for="font" class="input-label">
                            {{ recipe_form.font.label }}
                        </label>
                        <input type="text"
                               id="font"
                               name="{{ recipe_form.font.name }}"
                               value="{{ recipe_form.font.value  | default_if_none:'' }}"
                                {% if form.title.errors %}
                               class="input-error"
                                {% else %}
                               class="input"
                                {% endif %}
                               placeholder="{{ recipe_form.font.help_text }}">

                    </div>
                    <!-- directions -->
                    <div class="sm:col-span-2">
                        <label for="directions" class="input-label">
                            {{ recipe_form.directions.label }}
                        </label>
                        <textarea id="directions" rows="8"
                                  name="{{ recipe_form.directions.name }}"
                                  value="{{ recipe_form.directions.value }}"
                                {% if form.title.errors %}
                                  class="textarea-error"
                                {% else %}
                                  class="textarea "
                                {% endif %}
                                  placeholder="{{ recipe_form.directions.help_text }}"
                                  required></textarea>
                        {% for err in recipe_form.directions.errors %}
                            <p class="input-error-message">{{ err }}
                            </p>
                        {% endfor %}
                    </div>

                    <!-- Ingredients block -->
                    <div class="grid grid-cols-8 gap-1.5 sm:col-span-2 max-h-24">
                        <!-- Header -->
                        <span class="col-span-8 font-bold text-xl border-b-4 border-b-black">Ingredientes</span>
                        <span>Valor</span>
                        <span>Metrica</span>
                        <span class="col-span-2">Ingredient</span>
                        <span class="col-span-3">Qualificador</span>

                    </div>

                    <!-- ingredients:formset -->
                    <div class="grid grid-cols-8 gap-1.5 sm:col-span-2 max-h-32
                                border-y py-2">
                        {{ ingredient_formset.management_form }}
                        {% for ingredient_form in ingredient_formset %}
                            <!-- qtd -->
                            <div>
                                <input type="number"
                                       name="{{ ingredient_form.qtd.html_name }}"
                                       value="{{ ingredient_form.qtd.value }}"
                                       class="input"
                                       placeholder="0"
                                       required/>
                            </div>


                            <!-- metric -->
                            <div>
                                <select
                                        name="{{ ingredient_form.metric.html_name }}"
                                        class="input">
                                    {% for choice in ingredient_form.metric %}
                                        {{ choice }}
                                    {% endfor %}

                                </select>
                            </div>

                            <!-- ingredient -->

                            <div class="col-span-2 flex w-full">
                                <div
                                        x-data="{
                                    open: false,
                                    label: 'Selecione ...',
                                    selectedId: 0,
                                    select(el) {
                                        this.label = el.innerText
                                        this.selectedId = el.id
                                        this.toggle()
                                    },
                                    toggle() {
                                        if (this.open) {
                                            return this.close()
                                        }
                                        this.$refs.button.focus()
                                        this.open = true
                                    },
                                    close(focusAfter) {
                                        if (! this.open) return
                                        this.open = false
                                        focusAfter && focusAfter.focus()
                                    }
                                    }"
                                        x-on:keydown.escape.prevent.stop="close($refs.button)"
                                        x-on:focusin.window="! $refs.panel.contains($event.target) && close()"
                                        x-id="['dropdown-button']"
                                        class="relative w-full"
                                >
                                    <!-- ingredient:the value to be post -->
                                    <input
                                            type="hidden"
                                            :value="selectedId"
                                            name="{{ ingredient_form.ingredient.html_name }}"
                                    >
                                    <!-- ingredient:button -->
                                    <button
                                            x-ref="button"
                                            x-on:click="toggle()"
                                            :aria-expanded="open"
                                            :aria-controls="$id('dropdown-button')"
                                            type="button"
                                            x-text="label"
                                            class="flex items-center justify-between bg-gray-50 border border-gray-300
                                               w-full rounded-full p-2 pl-4 font-light overflow-y-scroll">
                                        <!-- ingredient:chevron-down -->
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400"
                                             viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd"
                                                  d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                                                  clip-rule="evenodd"/>
                                        </svg>
                                    </button>

                                    <!-- ingredient:panel -->
                                    <div
                                            x-ref="panel"
                                            x-show="open"
                                            x-transition.origin.top.left
                                            x-on:click.outside="close($refs.button)"
                                            :id="$id('dropdown-button')"
                                            style="display: none;"
                                            class="absolute left-0 mt-2 w-full rounded-md bg-white
                                                p-2  shadow-md"
                                    >
                                        <input
                                                type="text"
                                                name="search"
                                                hx-get="{% url 'ingredients:search' %}"
                                                hx-params="search"
                                                hx-trigger="load, input changed delay:500ms, search"
                                                hx-target="#ingredient-search-results"
                                                class="input w-full"
                                        >


                                        <!-- ingredient:search_result -->
                                        <div id="ingredient-search-results"></div>
                                    </div>
                                </div>
                            </div>


                            <!-- qualifiers -->
                            <div class="grid grid-cols-2 col-span-3 gap-2 bg-gray-50 border border-gray-300
                                    rounded-md p-2 font-light overflow-y-scroll h-full">
                                {% for qualifier in ingredient_form.qualifiers %}
                                    <div>
                                        <input type="checkbox"
                                               name="{{ ingredient_form.qualifiers.html_name }}"
                                               value="{{ qualifier.data.value }}">
                                        <label for="langs_ruby">{{ qualifier.choice_label | title }}</label>
                                    </div>
                                {% endfor %}

                            </div>
                            <button type="button"
                                    class="btn-red h-fit">
                                Remover
                            </button>
                            </div>
                        {% endfor %}
                    <!-- Add ingredient button -->
                    <button type="submit"
                            class="btn w-fit self-end">
                        Adicionar ingrediente
                    </button>

                </div>
                <!-- submit button -->
                <button type="submit"
                        class="btn mt-4">
                    Inserir receita
                </button>
            </form>
        </div>
    </section>
{% endblock content %}