{% load i18n %}
<div id="recipe_create" class="card">
  <div class="card-body">
    <h5 class="card-title">Nova receita</h5>

    <form class="row g-3" autocomplete="off">
      {% csrf_token %}
      {% for hidden in form.hidden_fields %}
        {{ hidden }}
      {% endfor %}
      {{ form.non_field_errors }}

      <!-- Titulo -->
      <div class="col-md-12">
        <div class="form-floating">
          <input type="text" value="{{ form.title.value | default_if_none:'' }}" class="form-control"
                 name="{{ form.title.name }}" id="floatingName" placeholder="Título">
          <label for="floatingName">{{ form.title.label }}</label>
          {% for err in form.title.errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              {{ err }}
            </div>
          {% endfor %}

        </div>
      </div>

      <!-- Descrição -->
      <div class="col-12 form-floating">
          <textarea class="form-control" value="{{ form.description.value }}" placeholder="Descrição"
                    name="{{ form.description.name }}" id="floatingTextareaDescription"
                    style="height: 100px;"></textarea>
        <label for="floatingTextareaDescription">{{ form.description.label }}</label>
        {% for err in form.description.errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ err }}
          </div>
        {% endfor %}
      </div>

      <!-- Fonte -->
      <div class="col-md-12">
        <div class="form-floating">
          <input type="text" value="{{ form.font.value | default_if_none:'' }}" class="form-control"
                 name="{{ form.font.name }}" id="floatingName" placeholder="Título">
          <label for="floatingName">{{ form.font.label }}</label>
          {% for err in form.font.errors %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              {{ err }}
            </div>
          {% endfor %}

        </div>
      </div>

      <div id='recipe_add_ingredient' class='row g-3'>
        {{ ingredient_formset.management_form }}
        <h5 class="card-title">Ingredientes</h5>
        {% for ingredient_form in ingredient_formset %}
          <!-- ingredient -->
          <div id="{{ ingredient_form.prefix }}" class='row g-3 ingredient-block'>
            <div class="form-floating mb-3 col-12">
              <select class="form-select" name="{{ ingredient_form.ingredient.html_name }}"
                      id="{{ ingredient_form.ingredient.auto_id }}"
                      aria-label="Ingrediente">
                {% for choice in ingredient_form.ingredient %}
                  {{ choice }}
                {% endfor %}
              </select>
              <label for="{{ ingredient_form.ingredient.auto_id }}">Ingrediente</label>
              {% for err in ingredient_form.ingredient.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  {{ err }}
                </div>
              {% endfor %}
            </div>
            <!-- qtd -->
            <div class="form-floating col-md-4">
              <input type="number" value="{{ ingredient_form.qtd.value }}" name="{{ ingredient_form.qtd.html_name }}"
                     class="form-control" id="{{ ingredient_form.qtd.auto_id }}" placeholder="">
              <label for="{{ ingredient_form.qtd.auto_id }}">{{ ingredient_form.qtd.label }}</label>
              {% for err in ingredient_form.qtd.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  {{ err }}
                </div>
              {% endfor %}
            </div>
            <!-- metric_type -->
            <div class="form-floating mb-3 col-md-8">
              <select class="form-select" name="{{ ingredient_form.metric.html_name }}"
                      id="{{ ingredient_form.metric.auto_id }}"
                      aria-label="Metrica">
                {% for choice in ingredient_form.metric %}
                  {{ choice }}
                {% endfor %}
              </select>
              <label for="{{ ingredient_form.metric.auto_id }}">{{ ingredient_form.metric.label }}</label>
              {% for err in ingredient_form.metric.errors %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  {{ err }}
                </div>
              {% endfor %}
            </div>
            <!-- qualifier -->
            <div class="col-12">
              <label class="col-form-label">Qualificadores, se necessário</label>
              <div class="col-sm-10">
                <select name="{{ ingredient_form.qualifiers.html_name }}" id="{{ ingredient_form.qualifiers.auto_id }}"
                        class="form-select"
                        multiple="multiple"
                        aria-label="multiple select example">
                  {% for qualifier in ingredient_form.qualifiers %}
                    {{ qualifier }}
                  {% endfor %}
                </select>
              </div>
            </div>
            <!-- remove ingredient -->
            <div class="text-lg-end col-md">
              <a
                class="btn btn-danger" onclick="removeIngredientForm(this)">
                Remover ingrediente
              </a>
            </div>
          </div>

        {% endfor %}
      </div>
      <div class="text-lg-end col-md">
        <a
          class="btn btn-primary" onclick="addIngredientForm()">
          Adicionar ingrediente
        </a>
      </div>

      <!-- Preparo -->
      <div class="col-12 form-floating">
          <textarea class="form-control" value="{{ form.directions.value }}" placeholder="Preparo"
                    name="{{ form.directions.name }}" id="floatingTextareaDirections" style="height: 200px;"></textarea>
        <label for="floatingTextareaDirections">{{ form.directions.label }}</label>
        {% for err in form.directions.errors %}
          <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ err }}
          </div>
        {% endfor %}
      </div>

      <!-- Botão Incluir -->
      <div class="text-center">
        <button hx-post="{% url 'recipes:create' %}"
                hx-swap="outerHTML"
                hx-target="#recipe_create"
                class="btn btn-primary">
          Incluir
        </button>
      </div>

    </form>
  </div>
</div>
<script>
  function addIngredientForm() {
    const total_forms = document.getElementById('id_ingredients-TOTAL_FORMS');
    const form_idx = total_forms.value;
    const recipe_add = document.getElementById('recipe_add_ingredient');
    const new_form = document.getElementById('ingredients-0')
      .cloneNode(true)
      .outerHTML
      .replace(/-0-/g, '-' + form_idx + '-');
    recipe_add.insertAdjacentHTML('beforeend', new_form)
    total_forms.value = parseInt(form_idx) + 1;
  }

  function removeIngredientForm(el) {
    el.parentNode.parentNode.remove();
  }
</script>
